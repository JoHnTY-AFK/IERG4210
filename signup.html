<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signup - Dummy Shopping Website</title>
    <link rel="stylesheet" href="/styles/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <style>
        .field-error {
            color: #FF4B2B;
            font-size: 0.8rem;
            margin-top: 0.2rem;
            display: none;
        }
        .field-error.visible {
            display: block;
        }
        input.valid {
            border-color: #00D4FF;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
        }
        input.invalid {
            border-color: #FF4B2B;
            box-shadow: 0 0 8px rgba(255, 75, 43, 0.5);
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease;
        }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .notification-modal.visible .modal-content {
            animation: scaleIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="signup-wrapper">
        <div class="signup-container">
            <h1>Create Your Account</h1>
            <form id="signup-form" novalidate>
                <input type="hidden" name="csrfToken" id="csrfToken">
                <div class="form-group">
                    <input type="text" id="firstName" name="firstName" required placeholder=" " aria-describedby="firstName-error">
                    <label for="firstName">First Name</label>
                    <div id="firstName-error" class="field-error"></div>
                </div>
                <div class="form-group">
                    <input type="text" id="lastName" name="lastName" required placeholder=" " aria-describedby="lastName-error">
                    <label for="lastName">Last Name</label>
                    <div id="lastName-error" class="field-error"></div>
                </div>
                <div class="form-group">
                    <input type="email" id="email" name="email" required placeholder=" " aria-describedby="email-error">
                    <label for="email">Email</label>
                    <div id="email-error" class="field-error"></div>
                </div>
                <div class="form-group">
                    <input type="password" id="password" name="password" required placeholder=" " aria-describedby="password-error">
                    <label for="password">Password</label>
                    <div id="password-error" class="field-error"></div>
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder=" " aria-describedby="confirmPassword-error">
                    <label for="confirmPassword">Confirm Password</label>
                    <div id="confirmPassword-error" class="field-error"></div>
                </div>
                <div id="password-strength" class="password-strength"></div>
                <div id="form-error" class="error"></div>
                <button type="submit" id="details-submit">Signup</button>
            </form>
            <p class="back-link"><a href="/">Back to Home</a> | <a href="/login">Already have an account? Login</a></p>
        </div>
    </div>
    <div id="notification-modal" class="notification-modal">
        <div class="modal-content">
            <h2>Signup Successful!</h2>
            <p>Congrats! You're now part of the Dummy Shopping community.</p>
            <button id="modal-continue">Continue to Home</button>
        </div>
    </div>
    <div id="chat-box" class="chat-box">
        <button id="close-chat" class="close-chat">Ã—</button>
        <h3>Customer Support</h3>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input">
            <textarea id="chat-input" placeholder="Type your message..."></textarea>
            <button id="send-message">Send</button>
        </div>
    </div>
    <button id="chat-button" class="chat-button">Chat with Us</button>
    <script src="/chat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const errorDiv = document.getElementById('form-error');
            const signupForm = document.getElementById('signup-form');
            const submitButton = document.getElementById('details-submit');
            const passwordInput = document.getElementById('password');
            const passwordStrengthDiv = document.getElementById('password-strength');
            const notificationModal = document.getElementById('notification-modal');
            const continueButton = document.getElementById('modal-continue');
            const inputs = {
                firstName: document.getElementById('firstName'),
                lastName: document.getElementById('lastName'),
                email: document.getElementById('email'),
                password: document.getElementById('password'),
                confirmPassword: document.getElementById('confirmPassword')
            };
            const errors = {
                firstName: document.getElementById('firstName-error'),
                lastName: document.getElementById('lastName-error'),
                email: document.getElementById('email-error'),
                password: document.getElementById('password-error'),
                confirmPassword: document.getElementById('confirmPassword-error')
            };

            // Fetch CSRF token
            fetch('/csrf-token', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('csrfToken').value = data.csrfToken;
                })
                .catch(err => console.error('CSRF fetch error:', err));

            // Initialize label positioning
            Object.values(inputs).forEach(input => {
                if (input.value.trim() || document.activeElement === input) {
                    const label = input.nextElementSibling;
                    if (label && label.tagName === 'LABEL') {
                        label.style.top = '-0.5rem';
                        label.style.fontSize = '0.8rem';
                        label.style.color = 'var(--accent-color)';
                    }
                }
            });

            // Validation functions
            const nameRegex = /^[a-zA-Z\s\-]+$/;
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            function validateField(input, errorDiv, validateFn, errorMsg) {
                const value = input.value.trim();
                const isValid = validateFn(value);
                input.setAttribute('aria-invalid', !isValid);
                input.classList.toggle('valid', isValid && value);
                input.classList.toggle('invalid', !isValid && value);
                errorDiv.textContent = isValid || !value ? '' : errorMsg;
                errorDiv.classList.toggle('visible', !isValid && value);
                return isValid || !value;
            }

            // Real-time validation
            inputs.firstName.addEventListener('input', () => {
                validateField(
                    inputs.firstName,
                    errors.firstName,
                    value => nameRegex.test(value) && value.length <= 50,
                    'First name can only contain letters, spaces, or hyphens (max 50 chars).'
                );
            });

            inputs.lastName.addEventListener('input', () => {
                validateField(
                    inputs.lastName,
                    errors.lastName,
                    value => nameRegex.test(value) && value.length <= 50,
                    'Last name can only contain letters, spaces, or hyphens (max 50 chars).'
                );
            });

            inputs.email.addEventListener('input', () => {
                validateField(
                    inputs.email,
                    errors.email,
                    value => emailRegex.test(value),
                    'Please enter a valid email address.'
                );
            });

            inputs.password.addEventListener('input', () => {
                const isValid = validateField(
                    inputs.password,
                    errors.password,
                    value => value.length >= 8 && value.length <= 50,
                    'Password must be between 8 and 50 characters.'
                );
                // Password strength
                const password = inputs.password.value;
                let strength = 'weak';
                if (password.length >= 8 && /[A-Z]/.test(password) && /[0-9]/.test(password)) {
                    strength = 'strong';
                } else if (password.length >= 8) {
                    strength = 'medium';
                }
                passwordStrengthDiv.textContent = password ? `Password Strength: ${strength.charAt(0).toUpperCase() + strength.slice(1)}` : '';
                passwordStrengthDiv.className = `password-strength ${strength}`;
                // Re-validate confirm password
                if (inputs.confirmPassword.value) {
                    validateField(
                        inputs.confirmPassword,
                        errors.confirmPassword,
                        value => value === inputs.password.value,
                        'Passwords do not match.'
                    );
                }
            });

            inputs.confirmPassword.addEventListener('input', () => {
                validateField(
                    inputs.confirmPassword,
                    errors.confirmPassword,
                    value => value === inputs.password.value,
                    'Passwords do not match.'
                );
            });

            // Form submission
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorDiv.style.display = 'none';
                submitButton.classList.add('loading');
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner visible"></span> Signing up...';

                const firstName = inputs.firstName.value.trim();
                const lastName = inputs.lastName.value.trim();
                const email = inputs.email.value.trim();
                const password = inputs.password.value.trim();
                const confirmPassword = inputs.confirmPassword.value.trim();

                // Validate all fields
                const isFirstNameValid = validateField(
                    inputs.firstName,
                    errors.firstName,
                    value => nameRegex.test(value) && value.length <= 50,
                    'First name can only contain letters, spaces, or hyphens (max 50 chars).'
                );
                const isLastNameValid = validateField(
                    inputs.lastName,
                    errors.lastName,
                    value => nameRegex.test(value) && value.length <= 50,
                    'Last name can only contain letters, spaces, or hyphens (max 50 chars).'
                );
                const isEmailValid = validateField(
                    inputs.email,
                    errors.email,
                    value => emailRegex.test(value),
                    'Please enter a valid email address.'
                );
                const isPasswordValid = validateField(
                    inputs.password,
                    errors.password,
                    value => value.length >= 8 && value.length <= 50,
                    'Password must be between 8 and 50 characters.'
                );
                const isConfirmPasswordValid = validateField(
                    inputs.confirmPassword,
                    errors.confirmPassword,
                    value => value === password,
                    'Passwords do not match.'
                );

                if (!isFirstNameValid || !isLastNameValid || !isEmailValid || !isPasswordValid || !isConfirmPasswordValid) {
                    errorDiv.textContent = 'Please fix the errors above.';
                    errorDiv.style.display = 'block';
                    signupForm.classList.add('shake');
                    setTimeout(() => signupForm.classList.remove('shake'), 300);
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Signup';
                    return;
                }

                const formData = { firstName, lastName, email, password };

                try {
                    const csrfResponse = await fetch('/csrf-token', { credentials: 'include' });
                    const csrfData = await csrfResponse.json();
                    document.getElementById('csrfToken').value = csrfData.csrfToken;

                    const response = await fetch('/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...formData, csrfToken: csrfData.csrfToken }),
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        errorDiv.textContent = data.error || 'Failed to sign up. Please try again.';
                        errorDiv.style.display = 'block';
                        signupForm.classList.add('shake');
                        setTimeout(() => signupForm.classList.remove('shake'), 300);
                        console.error('Signup failed:', data.error);
                        await fetch('/csrf-token', { credentials: 'include' })
                            .then(res => res.json())
                            .then(data => document.getElementById('csrfToken').value = data.csrfToken);
                        submitButton.classList.remove('loading');
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Signup';
                        return;
                    }

                    notificationModal.classList.add('visible');
                    continueButton.addEventListener('click', () => {
                        window.location.href = `/?name=${encodeURIComponent(firstName + ' ' + lastName)}`;
                    });
                } catch (err) {
                    console.error('Signup error:', err);
                    errorDiv.textContent = 'An error occurred during signup. Please try again later.';
                    errorDiv.style.display = 'block';
                    signupForm.classList.add('shake');
                    setTimeout(() => signupForm.classList.remove('shake'), 300);
                    await fetch('/csrf-token', { credentials: 'include' })
                        .then(res => res.json())
                        .then(data => document.getElementById('csrfToken').value = data.csrfToken);
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Signup';
                }
            });

            // Handle focus and blur for label positioning
            Object.values(inputs).forEach(input => {
                input.addEventListener('focus', () => {
                    const label = input.nextElementSibling;
                    if (label && label.tagName === 'LABEL') {
                        label.style.top = '-0.5rem';
                        label.style.fontSize = '0.8rem';
                        label.style.color = 'var(--accent-color)';
                    }
                });
                input.addEventListener('blur', () => {
                    if (!input.value.trim()) {
                        const label = input.nextElementSibling;
                        if (label && label.tagName === 'LABEL') {
                            label.style.top = '50%';
                            label.style.transform = 'translateY(-50%)';
                            label.style.fontSize = '1rem';
                            label.style.color = 'var(--text-color)';
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>