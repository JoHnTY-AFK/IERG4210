<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>My Orders - Dummy Shopping Website</title>
      <link rel="stylesheet" href="/styles/main.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
   </head>
   <body>
      <header>
         <h1>Dummy Shopping Website</h1>
         <nav>
            <ul>
               <li><a href="/">Home</a></li>
               <li><a href="#">Categories</a></li>
               <li><a href="#">About</a></li>
               <li><a href="/admin" id="admin-link" style="display: none;">Admin</a></li>
               <li><a href="/orders" id="orders-link" style="display: none;">My Orders</a></li>
               <li>
                  <form id="logout-form" method="POST" action="/logout"><button type="submit" id="logout-link" style="display: none;">Logout</button></form>
               </li>
            </ul>
         </nav>
         <button id="user-status" class="user-status">Guest</button>
         <button id="cart-button" class="cart-button">Cart (0)</button>
      </header>
      <section class="orders">
         <h2>My Orders</h2>
         <ul id="order-list"></ul>
         <p class="back-link"><a href="/">Back to Home</a></p>
      </section>
      <div id="shopping-cart" class="shopping-cart">
         <button class="close-cart">×</button>
         <h3>Shopping Cart</h3>
         <ul class="cart-items"></ul>
         <button class="checkout">Checkout</button>
      </div>
      <footer>
         <p>© 2025 Dummy Shopping Website</p>
      </footer>
      <script src="/cart.js"></script>
      <script>
         document.addEventListener('DOMContentLoaded', () => {
             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const logoutForm = document.getElementById('logout-form');
                     logoutForm.insertAdjacentHTML('afterbegin', `<input type="hidden" name="csrfToken" value="${data.csrfToken}">`);
                     
                     logoutForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                         const button = logoutForm.querySelector('button[type="submit"]');
                         button.disabled = true;
                         
                         try {
                             const response = await fetch('https://ierg4210.koreacentral.cloudapp.azure.com/logout', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json',
                                     'X-CSRF-Token': data.csrfToken
                                 },
                                 credentials: 'include'
                             });
                             
                             if (!response.ok) throw new Error('Logout failed');
                             
                             const result = await response.json();
                             if (result.csrfToken) {
                                 document.querySelector('#logout-form input[name="csrfToken"]').value = result.csrfToken;
                             }
                             window.location.href = result.redirect || '/login';
                         } catch (err) {
                             console.error('Logout error:', err);
                             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                                 .then(res => res.json())
                                 .then(data => {
                                     document.querySelector('#logout-form input[name="csrfToken"]').value = data.csrfToken;
                                     window.location.href = '/login';
                                 });
                         } finally {
                             button.disabled = false;
                         }
                     });
                 })
                 .catch(err => console.error('CSRF fetch error:', err));
         
             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/user', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const userStatus = document.getElementById('user-status');
                     const logoutLink = document.getElementById('logout-link');
                     const adminLink = document.getElementById('admin-link');
                     const ordersLink = document.getElementById('orders-link');
                     
                     if (data.email !== 'Guest') {
                         userStatus.textContent = 'Logout';
                         logoutLink.style.display = 'inline';
                         userStatus.style.display = 'none';
                         ordersLink.style.display = 'inline';
                         
                         if (data.isAdmin && adminLink) {
                             adminLink.style.display = 'inline';
                         } else if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                         loadOrders(data.email);
                     } else {
                         userStatus.textContent = 'Login';
                         userStatus.style.display = 'inline';
                         logoutLink.style.display = 'none';
                         ordersLink.style.display = 'none';
                         if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                         window.location.href = '/login';
                     }
                 })
                 .catch(err => console.error('User fetch error:', err));
         });
         
         function loadOrders(email) {
             fetch(`https://ierg4210.koreacentral.cloudapp.azure.com/orders?email=${encodeURIComponent(email)}`, { credentials: 'include' })
                 .then(response => {
                     if (!response.ok) throw new Error('Orders fetch failed');
                     return response.json();
                 })
                 .then(orders => {
                     const orderList = document.getElementById('order-list');
                     orderList.innerHTML = '';
                     if (orders.length === 0) {
                         orderList.innerHTML = '<li>No orders found</li>';
                         return;
                     }
                     orders.forEach(order => {
                         const items = JSON.parse(order.items).map(item => 
                             `${item.quantity}x Product #${item.pid} ($${item.price})`
                         ).join(', ');
                         const li = document.createElement('li');
                         li.innerHTML = DOMPurify.sanitize(`
                             Order #${order.orderID} - ${items}
                             Total: $${order.total_price.toFixed(2)} - Status: ${order.status}
                             Created: ${new Date(order.created_at).toLocaleString()}
                         `);
                         orderList.appendChild(li);
                     });
                 })
                 .catch(err => {
                     console.error('Orders error:', err);
                     document.getElementById('order-list').innerHTML = '<li>Error loading orders</li>';
                 });
         }
      </script>
      <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9353ca292addb0e8',t:'MTc0NTQ3ODcxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
   <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935462d63ca2676e',t:'MTc0NTQ4NDk3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style436visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>