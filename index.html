<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Dummy Shopping Website</title>
      <link rel="stylesheet" href="/styles/main.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
   </head>
   <body>
      <header>
         <h1>Dummy Shopping Website</h1>
         <nav>
            <ul>
               <li><a href="/">Home</a></li>
               <li><a href="#">Categories</a></li>
               <li><a href="#">About</a></li>
               <li><a href="/admin" id="admin-link" style="display: none;">Admin</a></li>
               <li><a href="/orders" id="orders-link" style="display: none;">My Orders</a></li>
               <li>
                  <form id="logout-form" method="POST" action="/logout"><button type="submit" id="logout-link" style="display: none;">Logout</button></form>
               </li>
            </ul>
         </nav>
         <button id="user-status" class="user-status">Guest</button>
         <button id="cart-button" class="cart-button">Cart (0)</button>
      </header>
      <section class="breadcrumb">
         <p><a href="/">Home</a> > <span id="breadcrumb-category">All Categories</span></p>
      </section>
      <section class="category-select">
         <label for="category-select">Select Category:</label>
         <select id="category-select">
            <option value="">-- Select a Category --</option>
         </select>
      </section>
      <section class="product-list" id="product-list"></section>
      <div id="shopping-cart" class="shopping-cart">
         <button class="close-cart">×</button>
         <h3>Shopping Cart</h3>
         <ul class="cart-items"></ul>
      </div>
      <footer>
         <p>© 2025 Dummy Shopping Website</p>
         <div id="fb-root"></div>
         <div class="fb-like" data-href="https://ierg4210.koreacentral.cloudapp.azure.com/" data-width="" data-layout="standard" data-action="like" data-size="small" data-share="true"></div>
      </footer>
      <script src="/cart.js"></script>
      <script>
         (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v20.0&appId=9580308452083485';
            fjs.parentNode.insertBefore(js, fjs);
         }(document, 'script', 'facebook-jssdk'));
      </script>
      <script>
         document.addEventListener('DOMContentLoaded', () => {
             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const logoutForm = document.getElementById('logout-form');
                     logoutForm.insertAdjacentHTML('afterbegin', `<input type="hidden" name="csrfToken" value="${data.csrfToken}">`);
                     
                     logoutForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                         const button = logoutForm.querySelector('button[type="submit"]');
                         button.disabled = true;
                         
                         try {
                             const response = await fetch('https://ierg4210.koreacentral.cloudapp.azure.com/logout', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json',
                                     'X-CSRF-Token': data.csrfToken
                                 },
                                 credentials: 'include'
                             });
                             
                             if (!response.ok) throw new Error('Logout failed');
                             
                             const result = await response.json();
                             if (result.csrfToken) {
                                 document.querySelector('#logout-form input[name="csrfToken"]').value = result.csrfToken;
                             }
                             window.location.href = result.redirect || '/login';
                         } catch (err) {
                             console.error('Logout error:', err);
                             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
                                 .then(res => res.json())
                                 .then(data => {
                                     document.querySelector('#logout-form input[name="csrfToken"]').value = data.csrfToken;
                                     window.location.href = '/login';
                                 });
                         } finally {
                             button.disabled = false;
                         }
                     });
                 })
                 .catch(err => console.error('CSRF fetch error:', err));
         
             fetch('https://ierg4210.koreacentral.cloudapp.azure.com/user', { credentials: 'include' })
                 .then(res => res.json())
                 .then(data => {
                     const userStatus = document.getElementById('user-status');
                     const logoutLink = document.getElementById('logout-link');
                     const adminLink = document.getElementById('admin-link');
                     const ordersLink = document.getElementById('orders-link');
                     
                     if (data.email !== 'Guest') {
                         userStatus.textContent = 'Logout';
                         logoutLink.style.display = 'inline';
                         userStatus.style.display = 'none';
                         ordersLink.style.display = 'inline';
                         
                         if (data.isAdmin && adminLink) {
                             adminLink.style.display = 'inline';
                         } else if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                     } else {
                         userStatus.textContent = 'Login';
                         userStatus.style.display = 'inline';
                         logoutLink.style.display = 'none';
                         ordersLink.style.display = 'none';
                         if (adminLink) {
                             adminLink.style.display = 'none';
                         }
                         userStatus.onclick = () => window.location.href = '/login';
                     }
                 })
                 .catch(err => console.error('User fetch error:', err));
         
             if (document.getElementById('category-select')) {
                 fetch('https://ierg4210.koreacentral.cloudapp.azure.com/categories')
                     .then(response => {
                         if (!response.ok) throw new Error('Categories fetch failed');
                         return response.json();
                     })
                     .then(categories => {
                         const categorySelect = document.getElementById('category-select');
                         categories.forEach(category => {
                             const option = document.createElement('option');
                             option.value = `${category.catid}-${category.slug}`;
                             option.textContent = category.name;
                             categorySelect.appendChild(option);
                         });
         
                         const urlParams = new URLSearchParams(window.location.search);
                         const catid = urlParams.get('catid');
                         if (catid) {
                             categorySelect.value = catid;
                             loadProducts(catid);
                             document.getElementById('breadcrumb-category').textContent = categorySelect.options[categorySelect.selectedIndex].text;
                         } else {
                             const pathMatch = window.location.pathname.match(/\/(\d+)-([^\/]+)/);
                             if (pathMatch) {
                                 const catid = pathMatch[1];
                                 categorySelect.value = categories.find(c => c.catid == catid)?.value || '';
                                 loadProducts(catid);
                                 document.getElementById('breadcrumb-category').textContent = categories.find(c => c.catid == catid)?.name || 'All Categories';
                             } else {
                                 loadProducts();
                             }
                         }
                     })
                     .catch(err => console.error('Categories error:', err));
             }
         
             function loadProducts(catid = null) {
                 const url = catid ? `https://ierg4210.koreacentral.cloudapp.azure.com/products/${catid}` : 'https://ierg4210.koreacentral.cloudapp.azure.com/products';
                 fetch(url)
                     .then(response => {
                         if (!response.ok) throw new Error('Products fetch failed');
                         return response.json();
                     })
                     .then(products => {
                         const productList = document.getElementById('product-list');
                         productList.innerHTML = '';
                         products.forEach(product => {
                             const productDiv = document.createElement('div');
                             productDiv.className = 'product';
                             productDiv.innerHTML = DOMPurify.sanitize(`
                                 <a href="/${product.catid}-${product.category_slug}/${product.pid}-${product.product_slug}">
                                     <img src="${product.thumbnail || '/images/product' + product.pid + '.jpg'}" alt="${product.name}" class="thumbnail">
                                     <h3>${product.name}</h3>
                                 </a>
                                 <p>$${product.price}</p>
                                 <button class="add-to-cart" data-pid="${product.pid}" data-name="${product.name}" data-price="${product.price}">Add to Cart</button>
                             `);
                             productList.appendChild(productDiv);
                         });
                     })
                     .catch(err => console.error('Products error:', err));
             }
         
             document.getElementById('category-select').addEventListener('change', (e) => {
                 const value = e.target.value;
                 if (value) {
                     const [catid, slug] = value.split('-');
                     history.pushState({}, '', `/${catid}-${slug}/`);
                     loadProducts(catid);
                     document.getElementById('breadcrumb-category').textContent = e.target.options[e.target.selectedIndex].text;
                 } else {
                     history.pushState({}, '', '/');
                     loadProducts();
                     document.getElementById('breadcrumb-category').textContent = 'All Categories';
                 }
             });
         });
      </script>
      <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9353ca292addb0e8',t:'MTc0NTQ3ODcxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
   <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935462d63ca2676e',t:'MTc0NTQ4NDk3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935c8598cc6a7bc3',t:'MTc0NTU3MDI4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>